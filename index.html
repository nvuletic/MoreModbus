<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>MoreModbus: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MoreModbus
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li class="current"><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">MoreModbus Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>#MoreModbus <a href="https://travis-ci.com/Wolkabout/MoreModbus"></a></p>
<p>This is an abstraction layer over the <code>libmodbus</code> library. The functionality added allow creation of mappings that create more meaningful data from modbus registers, such as 32 bit types created from two registers, strings, and single bits from registers.</p>
<p>This library contains <code>Mappings</code>, the base building block. <code>Mapping</code> implies a single, logical bit of data. They are of different types different from the native modbus <code>uint16_t</code>, like:</p><ul>
<li>INT16, UINT16 (where UINT16 is native for registers)</li>
<li>INT32, UINT32, FLOAT</li>
<li>STRING</li>
<li>BOOL (where BOOL is native for discrete types)</li>
</ul>
<p>These are built using operations</p>
<table class="doxtable">
<tr>
<th align="center">TYPE </th><th align="center">OPERATIONS  </th></tr>
<tr>
<td align="center">INT32, UINT32 </td><td align="center">MERGE_BIG_ENDIAN, MERGE_LITTLE_ENDIAN </td></tr>
<tr>
<td align="center">FLOAT </td><td align="center">MERGE_FLOAT </td></tr>
<tr>
<td align="center">STRING </td><td align="center">STRINGIFY_ASCII, STRINGIFY_UNICODE </td></tr>
<tr>
<td align="center">BOOL </td><td align="center">TAKE_BIT </td></tr>
</table>
<ul>
<li>STRINGIFY_ASCII (0-127) and STRINGIFY_UNICODE (0-255) both store two characters as a single <code>uint16_t</code> (understandable to modbus)</li>
<li>TAKE_BIT in combination with an index takes an exact bit (0-15) of a 16-bit register</li>
</ul>
<p>You can create a <code>Device</code> that groups <code>Mappings</code>. A <code>Group</code> contains <code>Mappings</code> that can be read with a single modbus message, and then the data is aggregated to each <code>Mapping</code>, and parsed to requested type.</p>
<p>Also, there exists a <code>Reader</code> that takes in all devices. This part is multi-threaded, all devices get their own thread for reading the groups and parsing the data.</p>
<h2>Compiling</h2>
<p>This library requires:</p><ul>
<li>GNU GCC and G++</li>
<li>CMake</li>
<li>Libmodbus (this is downloaded by CMake automatically)</li>
<li>autoconf, automake, libtool (needed by Libmodbus)</li>
<li>lcov (necessary for test coverage)</li>
</ul>
<p>So run </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;sudo apt install autoconf automake libtool gcc g++ cmake lcov</div></div><!-- fragment --><p>And after that, run the configuration script </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;./configure.sh</div></div><!-- fragment --><p>The out directory should be generated, so move in there, and run build </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;cd out</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;make -j$(nproc)</div></div><!-- fragment --><p>After that, you can run the example </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;./MoreModbusExample</div></div><!-- fragment --><p>To run tests </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;make tests -j$(nproc)</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;./MoreModbusTests # if you want to run them again, make will run them once for you.</div></div><!-- fragment --><p>Also, as bonus, after you ran the tests, you can check their coverage by back to the <code>tools</code> directory </p><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;./coverage.sh</div></div><!-- fragment --><h2>Usage</h2>
<p>Create some mappings, you can create some normal mappings</p>
<h4>Default Mapping</h4>
<p>All the HOLDING_REGISTER/INPUT_REGISTER mappings by default are UInt16Mappings, and INPUT_CONTACT/COIL are BoolMapping.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{c++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;const auto&amp; normalRegisterMapping =</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  std::make_shared&lt;wolkabout::UInt16Mapping&gt;(&quot;U16M&quot;, wolkabout::RegisterMapping::RegisterType::HOLDING_REGISTER, 0);</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;const auto&amp; normalContactMapping =</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;  std::make_shared&lt;wolkabout::BoolMapping&gt;(&quot;BM&quot;, wolkabout::RegisterMapping::RegisterType::INPUT_CONTACT, 0);</div></div><!-- fragment --><h4>Multi Register Mapping</h4>
<p>You can create a multi-register mapping, by listing the addresses in a vector. You of course, need to list the operation for the mapping, and make it as a Int32Mapping, UInt32Mapping or StringMapping based on the return value you want.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{c++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;const auto&amp; stringMapping = std::make_shared&lt;wolkabout::StringMapping&gt;(</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  &quot;STR1&quot;, wolkabout::RegisterMapping::RegisterType::HOLDING_REGISTER, std::vector&lt;int16_t&gt;{0, 1, 2},</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;  wolkabout::RegisterMapping::OperationType::STRINGIFY_ASCII);</div></div><!-- fragment --><h4>Bit Mapping</h4>
<p>You can create a bit mapping, one that will take a single bit from a register.You need to enlist as type HOLDING_REGISTER / INPUT_REGISTER, the TAKE_BIT operation and the bit index.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{c++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;const auto&amp; getFirstBitMapping =</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;      std::make_shared&lt;wolkabout::BoolMapping&gt;(&quot;B4-1&quot;, wolkabout::RegisterMapping::RegisterType::HOLDING_REGISTER, 4,</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;                                               wolkabout::RegisterMapping::OperationType::TAKE_BIT, 0);</div></div><!-- fragment --><h3>Device</h3>
<p>Next you need to merge all the mappings into a device. While creating the device, you also hand it a slaveAddress, which will be used to access it over SERIAL/RTU if you use RS485 with multiple devices.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{c++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;const auto&amp; mappings = std::vector&lt;std::shared_ptr&lt;wolkabout::RegisterMapping&gt;&gt;{normalRegisterMapping, </div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;                                    normalContactMapping, stringMapping, getFirstBitMapping, getSecondBitMapping};</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;const auto&amp; device = std::make_shared&lt;wolkabout::ModbusDevice&gt;(</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;      &quot;Test Device 1&quot;, 1, mappings);</div></div><!-- fragment --><p>The device is also automatically creating <code>Groups</code>, so that part is completely out of the users hands.</p>
<p>If you want to be able to see mappings change in value, you have to set up the callback method. Of course, since you're getting the <code>std::shared_ptr&lt;RegisterMapping&gt;</code> you need to cast it by the output type, if you want access to the parsed value.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{c++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;device-&gt;setOnMappingValueChange([](const std::shared_ptr&lt;wolkabout::RegisterMapping&gt;&amp; mapping) {</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;    // You can do this for all output types.</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;    if (mapping-&gt;getOutputType() == wolkabout::RegisterMapping::OutputType::BOOL)</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;    {</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;        const auto&amp; boolMapping = std::dynamic_pointer_cast&lt;wolkabout::BoolMapping&gt;(mapping);</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;        LOG(DEBUG) &lt;&lt; &quot;Application: Mapping is bool, value : &quot; &lt;&lt; boolMapping-&gt;getBoolValue();</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;        if (!boolMapping-&gt;getBoolValue())</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;            boolMapping-&gt;writeValue(true);</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;    }</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;    else if (mapping-&gt;getOutputType() == wolkabout::RegisterMapping::OutputType::STRING)</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;    {</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;        const auto&amp; stringMapping = std::dynamic_pointer_cast&lt;wolkabout::StringMapping&gt;(mapping);</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;        LOG(DEBUG) &lt;&lt; &quot;Application: Mapping is string, value : &quot; &lt;&lt; stringMapping-&gt;getStringValue();</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;        if (stringMapping-&gt;getStringValue().empty())</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;            stringMapping-&gt;writeValue(&quot;Test&quot;);</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;    }</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;    else</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    {</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;        LOG(DEBUG) &lt;&lt; &quot;Application: Mapping &quot; &lt;&lt; mapping-&gt;getReference() &lt;&lt; &quot; value changed.&quot;;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;    }</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;});</div></div><!-- fragment --><h3>Client</h3>
<p>You can create a client, TCP/IP or SERIAL/RTU depending on your needs. This will be necessary for the reader.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{c++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;const auto&amp; modbusClient = std::make_shared&lt;wolkabout::LibModbusSerialRtuClient&gt;(</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;  &quot;/dev/tty0&quot;, 115200, 8, 1, wolkabout::LibModbusSerialRtuClient::BitParity::NONE, std::chrono::milliseconds(500));</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;const auto&amp; modbusClient =</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;  std::make_shared&lt;wolkabout::LibModbusTcpIpClient&gt;(&quot;&lt;IP ADDRESS&gt;&quot;, 502, std::chrono::milliseconds(500));</div></div><!-- fragment --><h3>Reader</h3>
<p>And the final part, is the reader logic, which needs the client, and list of all devices that the reader should read.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{c++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;const auto&amp; reader = std::make_shared&lt;wolkabout::ModbusReader&gt;(</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;      *modbusClient, std::vector&lt;std::shared_ptr&lt;wolkabout::ModbusDevice&gt;&gt;{device}, std::chrono::milliseconds(1000));</div></div><!-- fragment --><p>And the control to start/stop, you can invoke methods. While the reader is running, make sure your main thread doesn't stop running, because the whole program will stop, and the reader, with the program, will crash. You can do that with a while loop with a sleep method inside.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;{c++}</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;reader-&gt;start();</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;while (reader-&gt;isRunning())</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;{</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;    std::this_thread::sleep_for(std::chrono::milliseconds(1000));</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;}</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;reader-&gt;stop();</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
